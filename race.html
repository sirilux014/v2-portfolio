<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle Sprint ğŸ â€” Race Game</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #07090f;
            --surface: #0f1520;
            --surface2: #161d2e;
            --border: rgba(255, 255, 255, 0.08);
            --cyan: #00e5ff;
            --green: #10b981;
            --yellow: #fbbf24;
            --red: #f43f5e;
            --purple: #a855f7;
            --text: #f1f5f9;
            --muted: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .screen {
            display: none;
            min-height: 100vh;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* SETUP */
        #S1 {
            background: radial-gradient(ellipse at 50% 0%, rgba(0, 229, 255, .08) 0%, transparent 70%), var(--bg);
            padding: 2rem;
        }

        .logo {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .logo-e {
            font-size: 3.5rem;
            animation: float 3s ease-in-out infinite;
            display: block;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-8px)
            }
        }

        .logo h1 {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff, var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p {
            color: var(--muted);
            font-size: .85rem;
            margin-top: .3rem;
        }

        .setup-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.75rem;
            width: 100%;
            max-width: 480px;
        }

        label {
            display: block;
            font-size: .75rem;
            font-weight: 600;
            color: var(--muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin: .9rem 0 .4rem;
        }

        input {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 11px 14px;
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: border-color .2s;
        }

        input:focus {
            border-color: var(--cyan);
        }

        input::placeholder {
            color: var(--muted);
        }

        .cgrid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: .4rem;
        }

        .cbtn {
            background: var(--surface2);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 10px 4px;
            font-size: 1.3rem;
            cursor: pointer;
            text-align: center;
            transition: all .2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .cbtn span {
            font-size: .6rem;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
        }

        .cbtn:hover {
            border-color: rgba(255, 255, 255, .25);
            transform: scale(1.05);
        }

        .cbtn.sel {
            border-color: var(--cyan);
            background: rgba(0, 229, 255, .1);
        }

        .conn-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: .8rem;
            color: var(--muted);
            margin: .8rem 0 .2rem;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--red);
            transition: all .3s;
        }

        .dot.on {
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
        }

        .sbtn {
            width: 100%;
            padding: 14px;
            background: var(--cyan);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            transition: all .2s;
            letter-spacing: .5px;
            text-transform: uppercase;
            margin-top: .8rem;
        }

        .sbtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 229, 255, .4);
        }

        .sbtn:disabled {
            opacity: .35;
            cursor: not-allowed;
        }

        /* GAME */
        #S2 {
            display: none;
            flex-direction: column;
            padding: .5rem;
            align-items: center;
            background: var(--bg);
        }

        #S2.active {
            display: flex;
        }

        #gameCanvas {
            border-radius: 14px;
            border: 1px solid var(--border);
            max-width: 100%;
            display: block;
        }

        #plist {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: .4rem;
            margin-top: .75rem;
        }

        .player-bar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: .85rem;
        }

        .player-bar.me {
            border-color: rgba(0, 229, 255, .4);
        }

        .bar-bg {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, .07);
            border-radius: 3px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width .15s ease;
        }

        /* FINISH */
        #S3 {
            background: radial-gradient(ellipse at 50% 30%, rgba(251, 191, 36, .1) 0%, transparent 60%), var(--bg);
            padding: 2rem;
            gap: 1rem;
        }

        .wcard {
            text-align: center;
            background: var(--surface);
            border: 1px solid rgba(251, 191, 36, .3);
            border-radius: 20px;
            padding: 2rem;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 0 60px rgba(251, 191, 36, .1);
        }

        .wtrophy {
            font-size: 4.5rem;
            display: block;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: scale(1) rotate(-4deg)
            }

            50% {
                transform: scale(1.08) rotate(4deg)
            }
        }

        .wtitle {
            font-size: .75rem;
            font-weight: 700;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--yellow);
            margin: .5rem 0 .3rem;
        }

        .wchar {
            font-size: 2.2rem;
        }

        .wname {
            font-size: 2rem;
            font-weight: 800;
        }

        .wtime {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            color: var(--green);
            margin: .3rem 0;
        }

        .rlist,
        .hofpanel {
            width: 100%;
            max-width: 480px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
        }

        .rlist h3,
        .hofpanel h3 {
            padding: 10px 18px;
            font-size: .75rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--muted);
            border-bottom: 1px solid var(--border);
        }

        .hofpanel h3 {
            color: var(--purple);
            background: rgba(168, 85, 247, .05);
        }

        .rrow,
        .hofrow {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            border-bottom: 1px solid var(--border);
            font-size: .85rem;
        }

        .rrow:last-child,
        .hofrow:last-child {
            border-bottom: none;
        }

        .hofempty {
            padding: 16px;
            text-align: center;
            color: var(--muted);
            font-size: .85rem;
        }

        .hrank {
            width: 22px;
            font-size: .9rem;
        }

        .ag-btn {
            padding: 12px 32px;
            background: var(--cyan);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: .95rem;
            font-weight: 800;
            cursor: pointer;
            transition: all .2s;
            text-transform: uppercase;
        }

        .ag-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 229, 255, .4);
        }

        .bt-row {
            display: flex;
            gap: .75rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: .5rem;
        }
    </style>
</head>

<body>

    <!-- â”€â”€ SETUP â”€â”€ -->
    <div id="S1" class="screen active">
        <div class="logo">
            <span class="logo-e">ğŸ</span>
            <h1>Oracle Sprint</h1>
            <p>[ SPACE ] à¸§à¸´à¹ˆà¸‡ &nbsp;Â·&nbsp; [ SHIFT ] à¸à¸£à¸°à¹‚à¸”à¸”à¸‚à¹‰à¸²à¸¡à¸«à¸´à¸™ &nbsp;Â·&nbsp; Real-time Multiplayer</p>
        </div>
        <div class="setup-card">
            <label>Oracle Name</label>
            <input id="iName" placeholder="e.g. Smile Oracle" maxlength="20">
            <label>Character</label>
            <div class="cgrid" id="charGrid"></div>
            <label>Room Code</label>
            <input id="iRoom" value="Oracle" maxlength="20">
            <div class="conn-row">
                <span class="dot" id="dot"></span>
                <span id="connTxt">Connecting to MQTT...</span>
            </div>
            <button id="btnStart" class="sbtn" disabled>ğŸš€ JOIN RACE</button>
        </div>
    </div>

    <!-- â”€â”€ GAME â”€â”€ -->
    <div id="S2" class="screen">
        <canvas id="gameCanvas"></canvas>
        <div id="plist"></div>
    </div>

    <!-- â”€â”€ FINISH â”€â”€ -->
    <div id="S3" class="screen">
        <div class="wcard">
            <span class="wtrophy">ğŸ†</span>
            <div class="wtitle">Winner!</div>
            <div class="wchar" id="wChar"></div>
            <div class="wname" id="wName"></div>
            <div class="wtime" id="wTime"></div>
        </div>
        <div class="rlist" id="rList">
            <h3>ğŸ Race Results</h3>
        </div>
        <div class="hofpanel">
            <h3>â­ Hall of Fame</h3>
            <div id="hofList">
                <div class="hofempty">Loading...</div>
            </div>
        </div>
        <div class="bt-row">
            <button class="ag-btn" onclick="location.reload()">ğŸ” Race Again</button>
            <a href="index.html"
                style="padding:12px 20px;border:1px solid var(--border);border-radius:10px;color:var(--muted);text-decoration:none;font-size:.9rem;display:inline-flex;align-items:center;">â†
                Portfolio</a>
        </div>
    </div>

    <script>
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CONSTANTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const BROKER = 'wss://dustboy-wss-bridge.laris.workers.dev/mqtt';
        const HOF_TOPIC = 'OracleRace/v2/hof';
        const W = 900, H = 330;
        const ROAD_TOP = 155, ROAD_BOT = 268;
        const GROUND_Y = 248;      // feet of character on ground
        const PLAYER_X = 170;      // fixed screen X of my character
        const TRACK_PX = 6000;     // track total pixel length
        const STEP = 1.8;          // % per spacebar press
        const GRAVITY = 0.55;
        const JUMP_POWER = -13;    // initial jump velocity (negative = up)
        const JUMP_CLEAR = -32;    // yOffset must be < this to safely clear obstacle
        const OBS_PCTS = [16, 30, 45, 60, 75, 88]; // obstacle track % positions

        const CHARS = [
            { e: 'ğŸŒŠ', n: 'Water', c: '#06b6d4' },
            { e: 'ğŸ”¥', n: 'Fire', c: '#ef4444' },
            { e: 'âš¡', n: 'Lightning', c: '#eab308' },
            { e: 'ğŸŒ¿', n: 'Nature', c: '#22c55e' },
            { e: 'ğŸŒ™', n: 'Moon', c: '#a855f7' },
            { e: 'â­', n: 'Star', c: '#f59e0b' },
            { e: 'ğŸ‰', n: 'Dragon', c: '#dc2626' },
            { e: 'ğŸ¦‹', n: 'Spirit', c: '#ec4899' },
        ];

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // STATE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const myId = 'p_' + Math.random().toString(36).substr(2, 7);
        let myName = '', myCharObj = CHARS[0], myRoom = 'Oracle';
        let myPos = 0, myYOff = 0, myJumpV = 0;
        let myFinished = false, myFinishTime = null;
        let hitCD = 0, frameN = 0;
        let gamePhase = 'setup'; // setup|countdown|running|finished
        let cdVal = 3;
        let startTime = null, elapsed = 0;
        let players = {};  // id â†’ {name,char,color,pos,yOff,finished,finishTime}
        let hallOfFame = [];
        let winnerSet = false;
        let client = null, lastPub = 0;
        let spaceHeld = false;

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // SETUP SCREEN
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function buildCharGrid() {
            const g = document.getElementById('charGrid');
            CHARS.forEach((ch, i) => {
                const b = document.createElement('button');
                b.className = 'cbtn' + (i === 0 ? ' sel' : '');
                b.innerHTML = `${ch.e}<span>${ch.n}</span>`;
                b.onclick = () => {
                    document.querySelectorAll('.cbtn').forEach(x => x.classList.remove('sel'));
                    b.classList.add('sel');
                    myCharObj = ch;
                };
                g.appendChild(b);
            });
        })();

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CANVAS SETUP
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = W; canvas.height = H;

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // WORLD HELPERS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function w2s(wx) { return PLAYER_X + (wx - (myPos / 100) * TRACK_PX); }

        // Pre-generate scenery
        const TREES = [];
        for (let i = 0; i < 30; i++) {
            const wx = i * 220 + (i * 73) % 120;
            TREES.push({ wx, y: ROAD_TOP - 12 - (i * 31) % 50, sz: 34 + (i * 7) % 18, e: ['ğŸŒ²', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´'][i % 4], top: true });
            TREES.push({ wx: wx + 110 + ((i * 59) % 80), y: ROAD_BOT + 30 + (i * 17) % 22, sz: 32 + (i * 11) % 16, e: ['ğŸŒ²', 'ğŸŒ´', 'ğŸŒ³', 'ğŸŒ¿'][i % 4], top: false });
        }
        const CLOUDS = Array.from({ length: 10 }, (_, i) => ({ wx: i * 900 + (i * 137) % 300, y: 18 + (i * 43) % 60 }));

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // DRAW FUNCTIONS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function drawBG() {
            // Sky
            const sky = ctx.createLinearGradient(0, 0, 0, ROAD_TOP);
            sky.addColorStop(0, '#60a5fa');
            sky.addColorStop(1, '#a3e635');
            ctx.fillStyle = sky; ctx.fillRect(0, 0, W, ROAD_TOP);

            // Distant hills
            ctx.fillStyle = '#4ade80';
            ctx.beginPath(); ctx.moveTo(0, ROAD_TOP);
            const mwx = (myPos / 100) * TRACK_PX;
            for (let x = 0; x <= W; x += 8) {
                const hx = mwx * 0.06 + x;
                const y = ROAD_TOP - 22 - 16 * Math.sin(hx / 200) - 10 * Math.sin(hx / 80);
                x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.lineTo(W, ROAD_TOP); ctx.closePath(); ctx.fill();

            // Clouds
            CLOUDS.forEach(c => {
                const sx = w2s(c.wx * 0.1);
                if (sx < -80 || sx > W + 80) return;
                ctx.globalAlpha = 0.65;
                ctx.font = '32px serif';
                ctx.fillText('â˜ï¸', sx, c.y);
                ctx.fillText('â˜ï¸', sx + 38, c.y - 8);
                ctx.globalAlpha = 1;
            });
        }

        function drawRoad() {
            // Road surface
            ctx.fillStyle = '#1e293b'; ctx.fillRect(0, ROAD_TOP, W, ROAD_BOT - ROAD_TOP);

            // Top edge fencing
            ctx.fillStyle = '#fff'; ctx.fillRect(0, ROAD_TOP, W, 3);
            ctx.fillStyle = '#fff'; ctx.fillRect(0, ROAD_BOT - 3, W, 3);

            // Road stripes (decorative)
            for (let lx = 0; lx < W; lx += 30) {
                ctx.fillStyle = 'rgba(255,255,255,0.06)';
                ctx.fillRect(lx, ROAD_TOP + 20, 14, ROAD_BOT - ROAD_TOP - 40);
            }

            // Center dashed line (scroll with track)
            const off = (((myPos / 100) * TRACK_PX) % 80);
            ctx.setLineDash([50, 30]);
            ctx.setLineDashOffset(-off);
            ctx.strokeStyle = 'rgba(255,255,255,0.35)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, (ROAD_TOP + ROAD_BOT) / 2);
            ctx.lineTo(W, (ROAD_TOP + ROAD_BOT) / 2);
            ctx.stroke();
            ctx.setLineDash([]); ctx.setLineDashOffset(0);

            // Start line
            const sx0 = w2s(0);
            drawCheckered(sx0);

            // Finish line
            const sxF = w2s(TRACK_PX);
            drawCheckered(sxF, '#fbbf24');
            if (sxF > 0 && sxF < W) { ctx.font = '16px serif'; ctx.fillText('ğŸ', sxF - 6, ROAD_TOP - 10); }
        }

        function drawCheckered(sx, glow) {
            if (sx < -14 || sx > W + 14) return;
            const sqh = (ROAD_BOT - ROAD_TOP) / 8;
            for (let i = 0; i < 8; i++) {
                ctx.fillStyle = i % 2 === 0 ? '#fff' : '#111';
                ctx.fillRect(sx - 5, ROAD_TOP + i * sqh, 10, sqh);
            }
            if (glow) {
                ctx.strokeStyle = glow; ctx.lineWidth = 2;
                ctx.strokeRect(sx - 5, ROAD_TOP, 10, ROAD_BOT - ROAD_TOP);
            }
        }

        function drawTrees() {
            const topTrees = TREES.filter(t => t.top);
            topTrees.forEach(t => {
                const sx = w2s(t.wx * 0.65);
                if (sx < -60 || sx > W + 60) return;
                ctx.font = t.sz + 'px serif'; ctx.fillText(t.e, sx, t.y);
            });
        }

        function drawBottomTrees() {
            const botTrees = TREES.filter(t => !t.top);
            botTrees.forEach(t => {
                const sx = w2s(t.wx * 0.65);
                if (sx < -60 || sx > W + 60) return;
                ctx.font = t.sz + 'px serif'; ctx.fillText(t.e, sx, t.y);
            });
        }

        function drawGrass() {
            const g = ctx.createLinearGradient(0, ROAD_BOT, 0, H);
            g.addColorStop(0, '#16a34a'); g.addColorStop(1, '#166534');
            ctx.fillStyle = g; ctx.fillRect(0, ROAD_BOT, W, H - ROAD_BOT);
        }

        function drawObstacles() {
            OBS_PCTS.forEach(pct => {
                const sx = w2s((pct / 100) * TRACK_PX);
                if (sx < -50 || sx > W + 50) return;
                ctx.font = '38px serif';
                ctx.fillText('ğŸª¨', sx - 19, GROUND_Y + 4);
            });
        }

        function drawOtherPlayers() {
            Object.values(players).forEach(p => {
                if (p.id === myId) return;
                const psx = w2s((p.pos / 100) * TRACK_PX);
                if (psx < -60 || psx > W + 80) return;
                const psy = GROUND_Y + (p.yOff || 0) - 8;
                ctx.globalAlpha = 0.55;
                ctx.font = '38px serif';
                ctx.fillText(p.char, psx - 19, psy);
                ctx.globalAlpha = 1;
                ctx.fillStyle = p.color || '#94a3b8';
                ctx.font = '10px Inter,sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(p.name.substring(0, 10), psx, GROUND_Y + 18);
                ctx.textAlign = 'left';
            });
        }

        function drawMyPlayer() {
            if (hitCD > 0 && Math.floor(hitCD / 5) % 2 === 0) { ctx.globalAlpha = 0.25; }
            const tilt = (frameN % 30 < 15) ? 0.08 : -0.08;
            const sy = GROUND_Y + myYOff - 10;
            ctx.save();
            ctx.translate(PLAYER_X + 2, sy);
            ctx.rotate(tilt);
            ctx.font = '44px serif';
            ctx.fillText(myCharObj.e, -22, 0);
            ctx.restore();
            ctx.globalAlpha = 1;
        }

        function drawHUD() {
            // Timer
            const tStr = elapsed.toFixed(1) + 's';
            ctx.fillStyle = 'rgba(0,0,0,0.55)';
            ctx.beginPath(); ctx.roundRect(W - 102, 8, 94, 34, 8); ctx.fill();
            ctx.fillStyle = '#fbbf24';
            ctx.font = 'bold 18px "JetBrains Mono",monospace';
            ctx.textAlign = 'right';
            ctx.fillText(tStr, W - 14, 31);
            ctx.textAlign = 'left';

            // Progress bar card
            ctx.fillStyle = 'rgba(0,0,0,0.55)';
            ctx.beginPath(); ctx.roundRect(8, 8, 220, 56, 10); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,0.07)';
            ctx.beginPath(); ctx.roundRect(16, 38, 200, 12, 5); ctx.fill();
            ctx.fillStyle = myCharObj.c;
            const barW = Math.min(200, (myPos / 100) * 200);
            ctx.beginPath(); ctx.roundRect(16, 38, barW, 12, 5); ctx.fill();
            ctx.fillStyle = '#f1f5f9';
            ctx.font = 'bold 12px Inter,sans-serif';
            ctx.fillText(`${myCharObj.e} ${myName || 'You'}`, 14, 32);
            ctx.fillStyle = '#94a3b8';
            ctx.font = '11px Inter,sans-serif';
            ctx.textAlign = 'right'; ctx.fillText(myPos.toFixed(1) + '%', 214, 32); ctx.textAlign = 'left';

            // Key hint
            if (!myFinished) {
                ctx.fillStyle = 'rgba(0,0,0,0.4)';
                ctx.beginPath(); ctx.roundRect(W / 2 - 148, H - 42, 296, 32, 8); ctx.fill();
                ctx.fillStyle = '#cbd5e1';
                ctx.font = '11px Inter,sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('[SPACE] à¸§à¸´à¹ˆà¸‡  Â·  [SHIFT] à¸à¸£à¸°à¹‚à¸”à¸” ğŸª¨  Â·  à¸­à¸¢à¹ˆà¸²à¸Šà¸™à¸«à¸´à¸™!', W / 2, H - 21);
                ctx.textAlign = 'left';
            }

            // Red vignette on hit
            if (hitCD > 0) {
                ctx.strokeStyle = `rgba(239,68,68,${Math.min(0.7, hitCD / 90 * 0.7)})`;
                ctx.lineWidth = 18; ctx.strokeRect(0, 0, W, H);
            }

            // Finish banner
            if (myFinished) {
                ctx.fillStyle = 'rgba(251,191,36,0.15)';
                ctx.fillRect(0, 0, W, H);
                ctx.fillStyle = '#fbbf24';
                ctx.font = 'bold 38px Inter,sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ FINISHED! ' + myFinishTime + 's ğŸ', W / 2, H / 2);
                ctx.textAlign = 'left';
            }
        }

        function drawCountdown() {
            ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(0, 0, W, H);
            ctx.fillStyle = '#f1f5f9'; ctx.font = 'bold 22px Inter,sans-serif'; ctx.textAlign = 'center';
            ctx.fillText('GET READY!', W / 2, H / 2 - 45);
            ctx.fillStyle = '#fbbf24';
            ctx.font = 'bold 100px Inter,sans-serif';
            ctx.fillText(cdVal > 0 ? cdVal : 'GO!', W / 2, H / 2 + 38);
            ctx.textAlign = 'left';
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // GAME LOOP
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function update() {
            if (gamePhase !== 'running') return;
            frameN++;

            // Jump physics
            if (myYOff < 0 || myJumpV !== 0) {
                myYOff += myJumpV;
                myJumpV += GRAVITY;
                if (myYOff >= 0) { myYOff = 0; myJumpV = 0; }
            }

            // Collision
            if (hitCD > 0) hitCD--;
            else {
                OBS_PCTS.forEach(pct => {
                    const sx = w2s((pct / 100) * TRACK_PX);
                    if (sx > PLAYER_X - 26 && sx < PLAYER_X + 26) {
                        if (myYOff < JUMP_CLEAR) return; // jumped over!
                        // HIT
                        myPos = Math.max(0, myPos - 8);
                        hitCD = 90;
                    }
                });
            }

            elapsed = startTime ? (Date.now() - startTime) / 1000 : 0;

            if (myPos >= 100 && !myFinished) {
                myFinished = true;
                myFinishTime = elapsed.toFixed(2);
                pubMe(true);
                setTimeout(checkWinner, 1200);
            }

            if (Date.now() - lastPub > 150) pubMe(false);
        }

        function render() {
            ctx.clearRect(0, 0, W, H);
            drawBG();
            drawTrees();
            drawRoad();
            drawObstacles();
            drawOtherPlayers();
            drawGrass();
            drawBottomTrees();
            drawMyPlayer();
            drawHUD();
            if (gamePhase === 'countdown') drawCountdown();
        }

        let raf = null;
        function loop() {
            update(); render();
            raf = requestAnimationFrame(loop);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MULTIPLAYER - PLAYERS LIST
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderPList() {
            const all = [{ id: myId, name: myName, char: myCharObj.e, color: myCharObj.c, pos: myPos, finished: myFinished, finishTime: myFinishTime },
            ...Object.values(players)].sort((a, b) => b.pos - a.pos);
            const c = document.getElementById('plist');
            c.innerHTML = all.map(p => `
        <div class="player-bar ${p.id === myId ? 'me' : ''}">
            <span>${p.char}</span>
            <span style="font-weight:600;min-width:110px">${p.name.substring(0, 14)}${p.id === myId ? ' <span style="font-size:.65rem;background:var(--cyan);color:#000;padding:2px 5px;border-radius:3px;font-weight:700">YOU</span>' : ''}</span>
            <div class="bar-bg"><div class="bar-fill" style="width:${Math.min(100, p.pos || 0)}%;background:${p.color || '#64748b'}"></div></div>
            <span style="font-family:'JetBrains Mono',monospace;font-size:.8rem;color:#94a3b8;min-width:45px;text-align:right">${(p.pos || 0).toFixed(0)}%</span>
            ${p.finished ? `<span style="font-size:.75rem;color:var(--green)">${p.finishTime}s</span>` : ''}
        </div>
    `).join('');
        }
        setInterval(renderPList, 200);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // WINNER / FINISH
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function checkWinner() {
            if (winnerSet) return;
            const fin = Object.values(players).filter(p => p.finished);
            if (myFinished) fin.push({ id: myId, name: myName, char: myCharObj.e, color: myCharObj.c, pos: 100, finished: true, finishTime: myFinishTime });
            if (fin.length === 0) return;
            fin.sort((a, b) => parseFloat(a.finishTime) - parseFloat(b.finishTime));
            winnerSet = true;
            showFinish(fin[0], fin);
        }

        function showFinish(winner, finishedList) {
            document.getElementById('wChar').textContent = winner.char;
            document.getElementById('wName').textContent = winner.name;
            document.getElementById('wTime').textContent = winner.finishTime + 's';

            // Results
            const allP = [...finishedList, ...Object.values({ ...players, [myId]: { id: myId, name: myName, char: myCharObj.e, color: myCharObj.c, pos: myPos, finished: myFinished, finishTime: myFinishTime } })
                .filter(p => !p.finished)];
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            const rl = document.getElementById('rList');
            rl.innerHTML = '<h3>ğŸ Race Results</h3>' + allP.map((p, i) => `
        <div class="rrow">
            <span>${medals[i] || '#' + (i + 1)}</span>
            <span>${p.char}</span>
            <span style="flex:1;font-weight:600">${p.name}${p.id === myId ? ' <span style="font-size:.65rem;background:var(--cyan);color:#000;padding:2px 5px;border-radius:3px">YOU</span>' : ''}</span>
            ${p.finishTime ? `<span style="font-family:'JetBrains Mono',monospace;color:var(--green)">${p.finishTime}s` : '<span style="color:var(--muted);font-size:.8rem">DNS</span>'}
        </div>`).join('');

            // Update HoF if I finished
            if (myFinished) updateHoF();
            renderHoF();

            // Switch screen after brief delay
            setTimeout(() => {
                cancelAnimationFrame(raf);
                show('S3');
            }, 1800);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // HALL OF FAME
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateHoF() {
            hallOfFame.push({ name: myName, char: myCharObj.e, time: parseFloat(myFinishTime), date: new Date().toLocaleDateString('th-TH') });
            hallOfFame.sort((a, b) => a.time - b.time);
            hallOfFame = hallOfFame.slice(0, 10);
            if (client && client.connected)
                client.publish(HOF_TOPIC, JSON.stringify(hallOfFame), { qos: 1, retain: true });
        }
        function renderHoF() {
            const h = document.getElementById('hofList');
            if (!hallOfFame.length) { h.innerHTML = '<div class="hofempty">No records yet â€” Be the first! ğŸŒŠ</div>'; return; }
            const rank = (i) => ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i] || '#' + (i + 1);
            h.innerHTML = hallOfFame.map((e, i) => `
        <div class="hofrow">
            <span class="hrank">${rank(i)}</span>
            <span>${e.char}</span>
            <span style="flex:1;font-weight:600">${e.name}</span>
            <span style="font-family:'JetBrains Mono',monospace;color:var(--green);font-size:.85rem">${e.time.toFixed(2)}s</span>
            <span style="color:var(--muted);font-size:.75rem;margin-left:4px">${e.date}</span>
        </div>`).join('');
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MQTT
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function mqttBase(room) { return `OracleRace/v2/${room}`; }

        function initMQTT() {
            client = mqtt.connect(BROKER, { reconnectPeriod: 3000 });
            client.on('connect', () => {
                setDot(true);
                document.getElementById('btnStart').disabled = false;
                client.subscribe(HOF_TOPIC, { qos: 1 });
            });
            client.on('message', (topic, payload) => {
                try {
                    const d = JSON.parse(payload.toString());
                    if (topic === HOF_TOPIC) { hallOfFame = Array.isArray(d) ? d : []; renderHoF(); return; }
                    if (!d.id || d.id === myId) return;
                    players[d.id] = { ...players[d.id], ...d };
                    if (d.finished && !winnerSet) checkWinner();
                } catch (_) { }
            });
            client.on('offline', () => setDot(false));
            client.on('error', () => setDot(false));
        }

        function pubMe(force = false) {
            if (!client || !client.connected) return;
            if (!force && Date.now() - lastPub < 150) return;
            lastPub = Date.now();
            client.publish(`${mqttBase(myRoom)}/runner/${myId}`, JSON.stringify({
                id: myId, name: myName, char: myCharObj.e, color: myCharObj.c,
                pos: myPos, yOff: myYOff, finished: myFinished, finishTime: myFinishTime
            }), { qos: 0, retain: false });
        }

        function setDot(on) {
            document.getElementById('dot').className = 'dot' + (on ? ' on' : '');
            document.getElementById('connTxt').textContent = on ? 'Connected' : 'Reconnecting...';
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // GAME START / COUNTDOWN
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function show(id) {
            document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.style.display = ''; });
            const s = document.getElementById(id);
            s.style.display = 'flex'; s.classList.add('active');
        }

        function startGame() {
            myName = document.getElementById('iName').value.trim() || 'Oracle';
            myRoom = (document.getElementById('iRoom').value.trim() || 'Oracle').replace(/\W/g, '');

            // Subscribe to the room
            client.subscribe(`${mqttBase(myRoom)}/runner/+`, { qos: 0 });

            players = {};
            myPos = 0; myYOff = 0; myJumpV = 0;
            myFinished = false; myFinishTime = null;
            hitCD = 0; frameN = 0; winnerSet = false; elapsed = 0;
            cdVal = 3; startTime = null;

            show('S2');
            loop();
            pubMe(true);

            // Countdown
            gamePhase = 'countdown';
            const cd = setInterval(() => {
                cdVal--;
                if (cdVal < 0) {
                    clearInterval(cd);
                    gamePhase = 'running';
                    startTime = Date.now();
                }
            }, 1000);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // INPUT
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.addEventListener('keydown', e => {
            if (e.repeat) return;
            if (e.code === 'Space' || e.key === ' ') {
                e.preventDefault();
                if (gamePhase === 'running' && !myFinished) {
                    myPos = Math.min(100, myPos + STEP);
                    players[myId] = { id: myId, name: myName, char: myCharObj.e, color: myCharObj.c, pos: myPos };
                }
                if (gamePhase === 'setup') document.getElementById('btnStart').click();
            }
            if ((e.code === 'ShiftLeft' || e.code === 'ShiftRight') && gamePhase === 'running' && !myFinished) {
                e.preventDefault();
                if (myYOff === 0 && myJumpV === 0) { myJumpV = JUMP_POWER; } // only jump when on ground
            }
            if (e.code === 'Enter' && gamePhase === 'setup') document.getElementById('btnStart').click();
        });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // BUTTON EVENTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.getElementById('btnStart').addEventListener('click', startGame);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // INIT
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        initMQTT();
    </script>
</body>

</html>